# Полный отчёт и код проекта «Эксперимент» (Python + PyQt5 + SQLite)

## Содержание

1. [Введение](#Введение)  
2. [Описание функционала](#Описание-функционала)  
3. [Требования к окружению](#Требования-к-окружению)  
4. [Архитектура и структура проекта](#Архитектура-и-структура-проекта)  
   1. [Основная идея](#Основная-идея)  
   2. [Общая структура](#Общая-структура)  
   3. [Зависимости между модулями](#Зависимости-между-модулями)  
5. [Описание файлов проекта](#Описание-файлов-проекта)  
   1. [`database.py`](#databasepy---инициализация-и-структура-бд)  
   2. [`models.py`](#modelspy---модели-и-заполнение-начальными-данными)  
   3. [`user_management.py`](#user_managementpy---управление-пользователями)  
   4. [`login.py`](#loginpy---окно-авторизации)  
   5. [`main_window.py`](#main_windowpy---главное-окно-приложения)  
   6. [Пакет `forms/`](#пакет-forms---формы-для-всех-подпунктов)  
   7. [`run.py`](#runpy---точка-входа)  
6. [Исходный код всех файлов](#Исходный-код-всех-файлов)  
7. [Принципы модульности](#Принципы-модульности)  
8. [Поддержка прав доступа](#Поддержка-прав-доступа)  
9. [Инструкции по запуску](#Инструкции-по-запуску)  
10. [Заключение](#Заключение)

---

## Введение

Данное приложение (условно названное «Эксперимент») разработано для демонстрации **базовой информационной системы** на языке Python с использованием библиотеки **PyQt5** для графического интерфейса и базы данных **SQLite3** для хранения данных.

### Основные цели приложения

- Обеспечить **регистрацию** и **авторизацию** пользователей.  
- **Суперпользователь** (администратор) имеет права выдавать другим пользователям доступ к разным частям функционала.  
- **Обычный пользователь** может работать только с теми пунктами меню, к которым у него есть соответствующие права.  
- Модульность и гибкость кода: отдельные файлы для **базы данных**, **логики** (моделей), **форм** (GUI), **главного окна** и т.д.  
- Демонстрация работы со справочниками, складскими документами, финансовым учётом и документами (выгрузка в Word/Excel, условно).

---

## Описание функционала

1. **Регистрация / Авторизация**:
   - При запуске приложения пользователь попадает в окно авторизации.
   - Если у него ещё нет учётной записи, он может зарегистрироваться.
   - Есть «скрытый» чекбокс для создания **суперпользователя**, но по умолчанию при первом запуске автоматически создаётся администратор (логин/пароль: `admin/admin`).

2. **Главное окно**:
   - После успешного входа в систему появляется **главное окно** (QMainWindow) с **меню**.
   - Структура меню загружается **динамически** из таблицы в базе данных (`MenuItems`).

3. **Пункты меню и подпункты**:
   - **Разное**: «Настройка», «Сменить пароль»  
   - **Сотрудники**: «Выдача прав доступа»  
   - **Справочники**: «Страны», «Банки», «Категории расходов» и др.  
   - **Склад**: «Накладная», «Заказ»  
   - **Финансовый учёт**: «Расходы предприятия», «Расчёт стоимости товара»  
   - **Документы**: «Накладные», «Заказы», «Финансовая отчётность»  
   - **Окно**: стандартные действия (каскадом, свернуть всё и т.д.)  
   - **Справка**: «Содержание», «О программе»  

4. **Права доступа**:
   - У каждого пользователя (кроме суперпользователя) есть **UserRights** на отдельные пункты меню.
   - Суперпользователь может изменять права (чтение, запись, удаление).

5. **Справочники** (Категории, Товары, Страны, Банки и т.д.):
   - Форма для просмотра/добавления/редактирования/удаления записей.
   - «Печать» (или вывод на печать) — пока в виде демонстрационного всплывающего окна.

6. **Склад**:
   - «Накладная» и «Заказ»: каждая имеет таблицу с полями (номер, дата и т.д.), связь с поставщиками/заказчиками.
   - Возможность просмотра документа (всплывающее окно или отдельная форма).

7. **Финансовый учёт**:
   - «Расходы предприятия» (дата, категория расходов, сумма и т.д.).
   - «Расчёт стоимости товара» (пользователь выбирает товар, приложение демонстрационно высчитывает условную «себестоимость» и сохраняет в отдельную таблицу).

8. **Документы**:
   - «Накладные», «Заказы» для печати/вывода в Word (имитация).
   - «Финансовая отчётность» для вывода в Excel (имитация).

9. **Справка**:
   - «Содержание»: отдельная форма со статическим текстом-оглавлением.
   - «О программе»: окно с версией, автором и прочей информацией.

---

## Требования к окружению

- **Python** версии 3.7+ (рекомендуется Python 3.9+).
- **PyQt5** (устанавливается через `pip install pyqt5`).
- **SQLite3** (обычно входит в стандартную поставку Python).
- При желании можно использовать визуальные темы Qt (`Fusion`, `Windows`, `Macintosh` и т.д.).

---

## Архитектура и структура проекта

### Основная идея

Проект следует принципу **MVC** (Model-View-Controller) в упрощённой форме:

- **Models**: Работа с данными (база SQLite, доступ через файлы `database.py`, `models.py`).  
- **View**: Формы PyQt5 (папка `forms`), главное окно (`main_window.py`), окно логина (`login.py`).  
- **Controller**: Логика, контролирующая работу (частично в `main_window.py`, а также в модулях форм).  

### Общая структура

1. **`database.py`** — инициализация базы, создание таблиц.  
2. **`models.py`** — модели для пользователей, пунктов меню и заполнение таблиц начальными данными.  
3. **`user_management.py`** — функции для регистрации, логина, смены пароля.  
4. **`login.py`** — окно авторизации/регистрации (QDialog).  
5. **`main_window.py`** — главное окно (QMainWindow), которое загружает меню из БД.  
6. **Папка `forms/`** — набор форм (QWidget) для каждого подпункта меню.  
7. **`run.py`** — точка входа (запускает приложение).  

### Зависимости между модулями

- `run.py` импортирует `login.py` и `main_window.py`, а также инициализирует БД.  
- `login.py` использует `user_management.py` для входа/регистрации.  
- `main_window.py` использует `database.py` и `models.py` (т.к. нужна структура меню).  
- Формы из `forms/` используют `database.py` напрямую для CRUD-операций.

Графически это можно изобразить так:

run.py ├──> database.py ├──> models.py ├──> login.py │ └──> user_management.py └──> main_window.py └──> forms/ ├── reference_.py (CRUD справочников) ├── warehouse_.py (Склад) ├── enterprise_.py (Финансы) └── doc_.py (Документы)


---

## Описание файлов проекта

### `database.py` — инициализация и структура БД

- Создаёт **`app_database.db`** (если нет).
- Имеет функцию `init_db()`, в которой создаются все таблицы: пользователи, права доступа, структура меню, справочники, складские/финансовые таблицы и т.д.
- Функция `get_connection()` возвращает `sqlite3.connect(...)` для работы с БД.

### `models.py` — модели и заполнение начальными данными

- Определяет класс **`MenuItem`** (для записи пункта меню).
- Метод `MenuItem.create_initial_menu_items()` заполняет таблицу `MenuItems` начальными данными (если она пуста): топ-уровень меню («Разное», «Сотрудники», «Справочники» и т.д.) и их подпункты.
- Определяет класс **`User`**, где метод `User.create_superuser_if_not_exists()` автоматически создаёт `admin/admin`, если не найден в БД.

### `user_management.py` — управление пользователями

- Содержит функции для **регистрации**, **логина**, **смены пароля** пользователей.
- Использует `get_connection()` для обращения к БД.
- Валидация данных пользователя (логин/пароль).

### `login.py` — окно авторизации

- Окно (QDialog) с полями: **логин**, **пароль**, кнопками **«Войти»**, **«Регистрация»** и опциональной галочкой «Суперпользователь?».
- При нажатии «Войти» вызывает `login_user(...)` из `user_management.py`; если успешно, закрывает окно (accept) и передаёт информацию о пользователе.
- При нажатии «Регистрация» вызывает `register_user(...)`.

### `main_window.py` — главное окно приложения

- Главное окно (QMainWindow) с **menuBar**.
- Загружает все пункты меню из `MenuItems` (упорядочено по `display_order`).
- Если у пункта нет `dll_name` и `func_name`, значит это **родительский пункт** (добавляем QMenu), а если есть — **конечный** (добавляем QAction).
- При нажатии на QAction вызывается метод `handle_menu_action(...)`, где:
  - Проверяются права (если пользователь не суперпользователь).
  - По умолчанию сейчас показывается `QMessageBox` с текстом «Здесь будет вызов формы...».  
  - В реальном приложении можно по `dll_name`/`func_name` **динамически** импортировать класс формы и отображать его.

### Пакет `forms/` — формы для всех подпунктов

В директории `forms/` находятся **все формы**, каждая в своём файле:

- **`settings_form.py`**: форма «Настройка» (пункт «Разное»).  
- **`change_password_form.py`**: форма «Сменить пароль» (проверка старого пароля, ввод нового).  
- **`user_rights_form.py`**: форма «Выдача прав доступа» (только для суперпользователя). Показывает список пользователей, пунктов меню, есть чекбоксы для can_read/can_write/can_delete.  
- **Формы справочников** (`reference_*.py`):  
  - Типовые действия (CRUD): добавление, редактирование, удаление, вывод на печать (или сообщение).  
- **Формы склада** (`warehouse_invoice_form.py`, `warehouse_order_form.py`):  
  - Операции с накладными и заказами (номер документа, дата, поставщик/клиент).  
- **Формы финансового учёта** (`enterprise_expenses_form.py`, `product_cost_calculation_form.py`):  
  - Расходы предприятия (дата, категория, сумма).  
  - Расчёт стоимости товара.  
- **Формы документов** (`doc_invoices_form.py`, `doc_orders_form.py`, `doc_fin_reports_form.py`):  
  - Выгрузка в Word/Excel (пока что имитация через `QMessageBox`).  
- **Стандартные пункты** «Окно» (каскад, свернуть и т.д.).
- **Справка**: `help_content_form.py` (содержание справочной системы), `about_form.py` (окно «О программе»).

### `run.py` — точка входа

- Запускает `init_db()`, затем `MenuItem.create_initial_menu_items()`, `User.create_superuser_if_not_exists()`.
- Создаёт объект `QApplication`, открывает `LoginWindow`.
- Если `LoginWindow` вернёт `Accepted`, значит вход успешен, открываем `MainWindow(user_data)`.
- Запуск основного цикла приложения (`app.exec_()`).

## 7. Принципы модульности

Приложение «Эксперимент» спроектировано с учётом разделения ответственности между модулями и минимизации внутренних зависимостей:

1. **Слой данных**:
   - Модуль `database.py` отвечает за инициализацию и подключение к базе данных SQLite3.
   - Модуль `models.py` содержит классические модели (структуры) и функции заполнения начальными данными (меню, суперпользователь).

2. **Логика работы с пользователями**:
   - Модуль `user_management.py` предоставляет функции для регистрации, авторизации, смены пароля.

3. **Слой представления (GUI)**:
   - `login.py` — окно авторизации (QDialog).
   - `main_window.py` — главное окно (QMainWindow) с динамическим созданием меню.
   - Пакет `forms/` (каждый подпункт меню — отдельная форма).

4. **Связь между слоями**:
   - Формы (во `forms/`) обращаются к БД через функции (в основном напрямую через `database.py`), не используя глобальные переменные.
   - Главное окно (`main_window.py`) только создаёт пункты меню и проверяет права доступа, а **не** реализует непосредственно бизнес-логику хранения данных.
   - `run.py` является точкой входа, где осуществляется начальная настройка (создание таблиц, добавление суперпользователя и пр.), а затем запуск интерфейса.

Такое разделение облегчает рефакторинг, добавление новых форм, смену способа хранения данных (при желании можно заменить SQLite на другую СУБД), доработку логики безопасности и т.д.

---

## 8. Поддержка прав доступа

В проекте реализована базовая модель разграничения прав:

1. **Суперпользователь** (администратор) может:
   - Заходить во все пункты меню без ограничений.
   - Управлять правами других пользователей (читать, писать, удалять).
   - Создавать новых пользователей.

2. **Обычный пользователь** по умолчанию не имеет прав доступа ни к одному пункту меню (кроме регистрации и авторизации).
   - Права ему выдаёт администратор (суперпользователь) в модуле «Выдача прав доступа».
   - В `main_window.py` при попытке открыть пункт меню идёт проверка, есть ли запись в `UserRights` с полем `can_read=1` (или `can_write`, `can_delete` при необходимости).

3. **Таблица `UserRights`** хранит записи вида:
   - `user_id` (какому пользователю принадлежат права),
   - `menu_item_id` (к какому пункту меню относятся права),
   - флаги `can_read`, `can_write`, `can_delete`.
   - На основании этих флагов приложение решает, разрешить ли пользователю открывать форму, редактировать данные и т.д.

Таким образом достигается гибкая настройка видимости и доступности функционала для каждого пользователя.

---

## 9. Инструкции по запуску

1. **Установка зависимостей**  
   - Необходим **Python 3.7+** (рекомендуется 3.9+ или выше).  
   - Установите библиотеку **PyQt5**:  
     ```bash
     pip install pyqt5
     ```

2. **Структура файлов**  
   Разместите файлы в соответствии с описанной архитектурой. Например:  

your_project/ ├─ database.py ├─ models.py ├─ user_management.py ├─ login.py ├─ main_window.py ├─ run.py └─ forms/ ├─ init.py ├─ ... (каждая форма .py)


3. **Первый запуск**  
- В терминале или командной строке в папке проекта выполните:
  ```bash
  python run.py
  ```
- При первом старте:
  1. Создастся файл базы данных `app_database.db`.
  2. Заполнится таблица `MenuItems`.
  3. Создастся суперпользователь `admin` с паролем `admin`.
- Откроется окно авторизации.

4. **Работа с приложением**  
- Введите логин «admin» и пароль «admin», чтобы войти как суперпользователь.
- Для обычного пользователя:
  - Нажмите «Регистрация», введите логин/пароль.
  - Зайдите под `admin` в меню «Сотрудники» -> «Выдача прав доступа», настройте права для вновь созданного пользователя.
- Все пункты меню («Разное», «Сотрудники», «Справочники», «Склад», «Финансовый учёт», «Документы», «Окно», «Справка») доступны суперпользователю.  
- Обычный пользователь увидит сообщения об отказе в доступе, если не имеет нужных прав (`can_read` и т.д.).

5. **Дополнительные настройки**  
- При необходимости можно отредактировать код `run.py`, чтобы применить другой графический стиль (например, `app.setStyle("Fusion")`) или задать собственную цветовую схему Qt.

---

## 10. Заключение

Приложение «Эксперимент» — это **демонстрационная платформа** для обучения и быстрого прототипирования информационных систем с GUI, где реализованы:

- **Модульность** кода (отдельные файлы по ролям).  
- **Хранение структуры меню в базе** (таблица `MenuItems`) с динамической генерацией меню.  
- **Аутентификация и разграничение прав** доступа.  
- **Справочники** (CRUD-операции), **учёт складских документов**, **финансовые учётные формы** и **документы** для выгрузки.  
- **Интуитивно понятный GUI** на **PyQt5**.

Такой подход легко масштабируется:
- Можно расширить перечень справочников.
- Реализовать детальные формы учёта товаров, складских остатков, финансов.
- Подключить настоящие механизмы экспорта в Word/Excel (через библиотеки `python-docx`, `openpyxl` и т.д.).
- Перейти на более мощную СУБД (PostgreSQL, MySQL) при увеличении нагрузки.

**Итог**: «Эксперимент» может служить **шаблоном** для создания более сложной учётной системы, удовлетворя многим типовым требованиям: авторизация, роли и права, справочники, работа с документами. 